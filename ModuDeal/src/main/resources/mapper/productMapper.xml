<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.application.moduDeal.product.dao.ProductDAO">

	<!-- 상품 저장 -->
	<insert id="saveProduct" parameterType="ProductDTO"
		useGeneratedKeys="true" keyProperty="productId">
		INSERT INTO PRODUCT (
		TITLE,
		DESCRIPTION,
		QTY,
		PRICE,
		PRODUCT_CATEGORY,
		USER_ID,
		PRODUCT_AT
		)
		VALUES (
		#{title},
		#{description},
		#{qty},
		#{price},
		#{productCategory},
		#{userId},
		#{productAt, jdbcType=TIMESTAMP}
		)
	</insert>

	<!-- 상품 이미지 저장 -->
	<insert id="saveProductImages" parameterType="List">
		INSERT INTO PRODUCT_IMG (
		IMG_UUID,
		PRODUCT_ID,
		IMG_ORIGINAL_NAME,
		IMG_AT
		)
		VALUES
		<foreach collection="list" item="item" separator=",">
			(
			#{item.imgUuid},
			#{item.productId},
			#{item.imgOriginalName},
			#{item.imgAt, jdbcType=TIMESTAMP}
			)
		</foreach>
	</insert>


	<!-- 상품 결과 매핑 -->
	<resultMap id="ProductResultMap" type="hashmap">
	    <result property="productId" column="PRODUCT_ID" />
	    <result property="title" column="TITLE" />
	    <result property="qty" column="QTY" />
	    <result property="price" column="PRICE" />
	    <result property="imgUuid" column="IMG_UUID" />
	    <result property="imgOriginalName" column="IMG_ORIGINAL_NAME" />
	    <result property="imgAt" column="IMG_AT" />
	    <result property="productAt" column="PRODUCT_AT" />
	</resultMap>
	
	<!-- 최근 상품 목록 가져오기 -->
	<select id="getRecentProducts" resultMap="ProductResultMap">
		SELECT
			P.PRODUCT_ID AS PRODUCT_ID,
			P.TITLE AS TITLE,
			P.PRICE AS PRICE,
			P.QTY AS QTY,
			P.DESCRIPTION AS DESCRIPTION,
			PI.IMG_UUID AS IMG_UUID,
			PI.IMG_ORIGINAL_NAME AS IMG_ORIGINAL_NAME,
			PI.IMG_AT AS IMG_AT
		FROM
			PRODUCT P
		LEFT JOIN
			PRODUCT_IMG PI ON P.PRODUCT_ID = PI.PRODUCT_ID
		ORDER BY 
			P.PRODUCT_AT DESC
		LIMIT 
			12
	</select>


	<select id="getFilteredProducts" resultMap="ProductResultMap" parameterType="map">
    SELECT
        P.PRODUCT_ID AS PRODUCT_ID,
        P.TITLE AS TITLE,
        P.PRICE AS PRICE,
        P.QTY AS QTY,
        P.DESCRIPTION AS DESCRIPTION,
        PI.IMG_UUID AS IMG_UUID,
        PI.IMG_ORIGINAL_NAME AS IMG_ORIGINAL_NAME,
        PI.IMG_AT AS IMG_AT
    FROM
        PRODUCT P
    LEFT JOIN
        PRODUCT_IMG PI ON P.PRODUCT_ID = PI.PRODUCT_ID
	    <where>
	        <if test="category != null and category != ''">
	            AND P.PRODUCT_CATEGORY = #{category}
	        </if>
	    </where>
	    ORDER BY P.PRODUCT_AT DESC
	    LIMIT 12
	</select>
</mapper>
